CONFIG_MUSL ?= y

# GCC 15.1.0 Upgrade Notes:
# - Upgraded from GCC 9.4.0 to 15.1.0 for improved -Oz optimization support
# - Multiple modules required C23 compatibility fixes (see individual module TODOs)
# - Systematic conversion from -Os to -Oz optimization across 33+ modules
# - Key compatibility issues resolved: bool/false conflicts, basename function, true keyword, inlining
ifeq "$(MUSL_CROSS_ONCE)" ""
MUSL_CROSS_ONCE := 1
modules-$(CONFIG_MUSL) += musl-cross-make

musl-cross-make_version := 3635262e4524c991552789af6f36211a335a77b3
musl-cross-make_dir := musl-cross-make-$(musl-cross-make_version)
musl-cross-make_url := https://github.com/richfelker/musl-cross-make/archive/$(musl-cross-make_version).tar.gz
musl-cross-make_tar := musl-cross-make-$(musl-cross-make_version).tar.gz
musl-cross-make_hash := 60bed670d689d5c2164020960df36b80189dc5617e9763e023672f98a99d567e


ifneq "$(CROSS)" ""

# check that $(CROSS)gcc exists or else things just won't work
ifneq "y" "$(shell [ -x '$(CROSS)gcc' ] && echo y)"
$(error $(CROSS)gcc does not exist - can not build)
else
$(info Using $(CROSS)gcc)
endif

# The cross compiler has already been built, so the musl-cross-make target
# is a NOP.  We really don't need to check out this code tree, but it is easier
# if we have a target for it.
musl-cross-make_target := --version

# Ask the compiler where to find its own libc.so
musl-cross-make_libraries := \
	$(shell $(CROSS)gcc --print-file-name=libc.so) \

else

# Force a full build of the cross compiler for target platform
# No need to build i386 for x86 since coreboot uses its own compiler
musl-cross-make_configure := \
	echo -e >> Makefile 'musl-target:' ; \
	echo -e >> Makefile '\t$$(MAKE) TARGET="$(MUSL_ARCH)-linux-musl" install' ;

CROSS_PATH ?= $(pwd)/crossgcc/$(CONFIG_TARGET_ARCH)

musl-cross-make_target := \
	OUTPUT="$(CROSS_PATH)" \
	MAKE="$(MAKE)" \
	$(MAKE_JOBS) \
	"musl-target"

CROSS := $(CROSS_PATH)/bin/$(subst -,_,$(MUSL_ARCH))-linux-musl-
musl-cross-make_libraries := $(CROSS_PATH)/$(subst -,_,$(MUSL_ARCH))-linux-musl/lib/libc.so

endif


musl-cross-make_output := $(CROSS)gcc

## Fake a target so that musl will force a header install by the
## Linux kernel sources.
$(build)/$(musl-cross-make_dir)/.build: $(INSTALL)/include/linux/limits.h


endif
