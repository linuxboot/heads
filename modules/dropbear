# dropbear is a tiny ssh client
modules-$(CONFIG_DROPBEAR) += dropbear

# Inventory classification: UNKNOWN

dropbear_version := 2025.88
dropbear_dir := dropbear-$(dropbear_version)
dropbear_tar := dropbear-$(dropbear_version).tar.bz2
dropbear_url := https://matt.ucc.asn.au/dropbear/releases/$(dropbear_tar)
dropbear_hash := 783f50ea27b17c16da89578fafdb6decfa44bb8f6590e5698a4e4d3672dc53d4

# Build with space-optimised flags. Force -Oz for the main build and set
# bundled libtommath to prefer size-friendly flags (configure respects
# LTM_CFLAGS/DROPBEAR_LTM_CFLAGS when provided in the environment).
# See other modules for examples: e.g., modules/gpg2
#
# NOTE: -Oz support here is partial — verbose builds show the main dropbear
#       compilation using -Oz while the *bundled* libtommath is built with
#       -Os (configurable via LTM_CFLAGS/DROPBEAR_LTM_CFLAGS). If you need
#       further size tuning or to hunt GCC15 regressions, explore the
#       libtommath/libtomcrypt flag variables (LTM_CFLAGS/LTC_CFLAGS) first.
#
# FIXED(-OFLAG): packaging-time sed normalizes optimization flags to `-Oz` only (replaces `-O[0-9]+` and `-Os` with `-Oz`). We intentionally do **not** strip `-funroll-loops` or `-fomit-frame-pointer` here — reintroducing those options into bundled libs did not change the final `dropbear`/`ssh` sizes in our experiments. Validated V=1: configure and build logs show `-Oz` for the main build, but a size regression remains versus an earlier CircleCI artifact (dropbear: 184,832 → 241,248; ssh: 176,416 → 233,048, both ≈ +56 KiB). Local builds use GCC 15.1.0 while the earlier artifact used GCC 9.4.0, so the most likely root cause is compiler/toolchain or upstream package-version changes rather than residual `-O` flags. Action: retain the minimal, reversible sed (creates `.bak`) for reproducibility; record this regression in `build_OFLAG_inventory.csv` and `doc/OFLAG_fixes.md` for future follow-up (possible experiments: rebuild with GCC 9.4, symbol/section diffs, or linker-level mitigations). Priority: Low.
#
# NOTE: network support under Heads is seldom used. The `#network-recovery-init`
#       hook (when present) is currently the main place that invokes dropbear
#       manually. Consider whether forcing -Oz globally for Dropbear is worth
#       pursuing if network-recovery is not in active use.
#
# TODO: Revisit and document any further flag experiments or required
#       compatibility fixes before widening -Oz usage elsewhere.
# Force main build to use -Oz and prefer -Oz for the bundled libtommath.
# This keeps main dropbear space-optimised while avoiding O3 for libtommath.
# Use Autotools' cross-compile mechanism so configure knows it's a cross
# build and won't probe the host compiler for runtime-only hardened flags.
# Use $(CROSS_TOOLS) so CC and other crosstools are set consistently.

dropbear_configure := \
	( \
		sed -E -i.bak 's/-O[0-9]+/-Oz/g; s/-Os/-Oz/g' configure libtommath/makefile_include.mk libtomcrypt/makefile_include.mk || true; \
	) && $(CROSS_TOOLS) \
	./configure \
	--host $(MUSL_ARCH)-linux-musl \
	--prefix "/" \
	--disable-lastlog \
	--disable-syslog \
	--disable-utmp \
	--disable-utmpx \
	--disable-wtmp \
	--disable-wtmpx \
	--disable-loginfunc \
	--disable-pututline \
	--disable-pututxline \
	--disable-openpty \
	--disable-shadow \

dropbear_target := \
	$(MAKE_JOBS) \
	$(CROSS_TOOLS) \
	DESTDIR="$(INSTALL)" \
	dbclient scp dropbear \
	&& \
	cp -a $(build)/$(dropbear_dir)/dbclient $(build)/$(dropbear_dir)/ssh

dropbear_output := ssh scp dropbear

dropbear_depends := zlib $(musl_dep)
