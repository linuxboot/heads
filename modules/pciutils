modules-$(CONFIG_PCIUTILS) += pciutils

pciutils_depends := $(musl_dep)

#pciutils_version := git
#pciutils_repo := https://github.com/osresearch/pciutils

pciutils_version := 3.5.4
pciutils_dir := pciutils-$(pciutils_version)
pciutils_tar := pciutils-$(pciutils_version).tar.xz
pciutils_url := https://www.kernel.org/pub/software/utils/pciutils/$(pciutils_tar)
pciutils_hash := 64293c6ab9318c40ef262b76d87bd9097531759752bac556e50979b1e63cfe66

# TODO(-OFLAG): OFLAG status: CONFIRMED â€” hardcoded -O2 (49 occurrences) observed in `pciutils` compile lines, preventing `CFLAGS=-Oz` from being decisive.
# Evidence: build/x86/log/pciutils.log contains many `-O2` gcc invocations.
# Action: use packaging-time `sed` to normalize optimization tokens to `-Oz` and keep the resulting `.bak` files as evidence (no upstream source patching; patches should only change runtime behaviour). Verify via V=1 package/board builds. Priority: Medium.
# Inventory classification: hardcoded -O2 (49 occurrences)
# Patch policy: if an upstream-source patch becomes necessary it must be placed under `patches/<package>-<version>/0001-<reason>.patch` and be named with a numbered prefix and short reason. For this package we include a source patch at `patches/pciutils-3.5.4/0001-add-PCI_HAVE_STDINT_H.patch` (non-OFLAG source fix). Compilation/build-time fixes remain packaging-time `sed` edits unless a source patch is required.


# IDSDIR must be set to a constant during the build,
# but not during the install to make the libpci.so.3
# reproducible.  Otherwise the build path will be embedded
# in the library and executables.

pciutils_target := \
	$(MAKE_JOBS) \
	$(CROSS_TOOLS) \
	HOST=$(MUSL_ARCH)-linux-musl \
	ZLIB=no \
	HWDB=no \
	LIBKMOD=no \
	SHARED=yes \
	IDSDIR="/" \
	PREFIX="/" \
	&& sed -E -i.bak 's/-O[0-9]+/-Oz/g; s/-Os/-Oz/g;' $(build)/$(pciutils_dir)/Makefile* $(build)/$(pciutils_dir)/*/Makefile* 2>/dev/null || true \
	&& \
	$(MAKE) \
	-C $(build)/$(pciutils_dir) \
	$(CROSS_TOOLS) \
	ZLIB=no \
	HWDB=no \
	LIBKMOD=no \
	SHARED=yes \
	PREFIX="/" \
	DESTDIR="$(INSTALL)" \
	install \
	install-lib \

pciutils_output := \
	lspci \

pciutils_libraries := \
	lib/libpci.so.3.5.4 \
	$(INSTALL)/lib/libpci.so.3\

pciutils_configure := 
