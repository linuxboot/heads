#!/bin/sh
# Final stage to start Tails
. /etc/functions
. /etc/config

KERNEL="$1"
INITRD="$2"

if [ -z "$KERNEL" -o -z "$INITRD" ]; then
	die "Usage: $0 /media/live/vmlinuz2 /media/live/initrd2.img "
fi

# TODO: parse commandline from sysconfig/liveamd64.cfg (replace quiet w/ intel_iommu=on vga=normal)

echo '+++ Loading kernel and initrd'
kexec \
	-l ${KERNEL} \
	--initrd=${INITRD} \
	--append="boot=live config live-media=removable apparmor=1 security=apparmor nopersistence noprompt timezone=Etc/UTC block.events_dfl_poll_msecs=1000 noautologin module=Tails kaslr slab_nomerge slub_debug=FZ mce=0 vsyscall=none  intel_iommu=on vga=normal" \
|| die "kexec load failed"

echo "+++ Starting Tails..."
exec kexec -e
