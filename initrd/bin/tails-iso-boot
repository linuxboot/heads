#!/bin/sh
# Final stage to start Tails
. /etc/functions
. /etc/config

KERNEL="$1"
INITRD="$2"
DEV="$3"
ISO="$4"

if [ -z "$KERNEL" -o -z "$INITRD" -o -z "$DEV" -o -z "$ISO" ]; then
	die "Usage: $0 /boot/live/vmlinuz2 /boot/live/initrd2.img /dev/sdb1 tails...iso "
fi

DEV_UUID=`blkid $DEV | tr " " "\n" | grep UUID | cut -d\" -f2`

# TODO: pass to kexec
#CMD_LINE=`grep "initrd2.*quiet" /boot/EFI/BOOT/liveamd64.cfg | cut -d\  -f3- | awk '{gsub(/quiet/,""); print}'`
#CMD_LINE="$CMD_LINE intel_iommu=yes vga=normal fromiso=/dev/disk/by-uuid/$DEV_UUID/$ISO"
#echo $CMD_LINE > /tmp/cmdline

echo '+++ Loading kernel and initrd'
kexec \
	-l ${KERNEL} \
	--initrd=${INITRD} \
	--append="boot=live config live-media=removable apparmor=1 security=apparmor nopersistence noprompt timezone=Etc/UTC block.events_dfl_poll_msecs=1000 splash noautologin module=Tails kaslr slab_nomerge slub_debug=FZ mce=0 vsyscall=none  intel_iommu=on vga=normal fromiso=/dev/disk/by-uuid/${DEV_UUID}/${ISO} " \
|| die "kexec load failed"

echo "+++ Starting Tails..."
exec kexec -e
