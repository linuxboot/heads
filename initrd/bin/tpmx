#!/bin/sh

# Abstraction layer over tpm commands to ensure the programmer does not have to
# care about TPM 1.2 vs TPM2

set -e pipefail

. /etc/functions

SECRET_DIR="/tmp/secret"
DEFAULT_HANDLE="0x81000000"
ENC_SESSION_FILE="enc.ctx"
DEC_SESSION_FILE="dec.ctx"

# @param: code to be extended
# @param (optional): PCR index to extend, default 4
extend()
{
	local ARGUMENT=$1
	local PCR=${2:-4}

	if [ "$CONFIG_TPM" = "y" ]; then
		tpm extend -ix $PCR -ic $ARGUMENT
	elif ["$CONFIG_TPM2" = "y" ]; then
		tpm2 pcrevent $PCR $ARGUMENT $1>/dev/null
	fi
}

# Clears all keys from the TPM and takes ownership
reset()
{
	echo '*****'
	echo '***** WARNING: This will erase all keys and secrets from the TPM'
	echo '*****'
	
	read -s -p "New TPM owner password: " key_password
	echo
	
	if [ -z "$key_password" ]; then
		die "Empty owner password is not allowed"
	fi
	
	read -s -p "Repeat owner password: " key_password2
	echo
	
	if [ "$key_password" != "$key_password2" ]; then
		die "Key passwords do not match"
	fi
	
	if [ "$CONFIG_TPM" = "y" ]; then
		# Make sure the TPM is ready to be reset
		tpm physicalpresence -s
		tpm physicalenable
		tpm physicalsetdeactivated -c
		tpm forceclear
		tpm physicalenable
		tpm takeown -pwdo "$key_password"
		
		# And now turn it all back on
		tpm physicalpresence -s
		tpm physicalenable
		tpm physicalsetdeactivated -c
	
	elif [ "$CONFIG_TPM2" = "y" ]; then
		mkdir -p "$SECRET_DIR"
		tpm2 clear -c platform
		tpm2 changeauth -c owner "$key_password"
		tpm2 createprimary -C owner -g sha256 -G \ 
			"${CONFIG_PRIMARY_KEY_TYPE:-rsa}" \ 
			-c "$SECRET_DIR/primary.ctx" -P "$key_password"
		tpm2 evictcontrol -C owner -c "$SECRET_DIR/primary.ctx" \ 
			"$DEFAULT_HANDLE" -P "$key_password"
		startsession
	fi
}

# TPM2 Only, start an auth session with the TPM.  Should be done very early on 
# to prevent TPM sniffing attacks
tpm2_startsession()
{
	if [ "$CONFIG_TPM2" = "y" ]; then
		mkdir -p "$SECRET_DIR"
		tpm2 startauthsession -c "$DEFAULT_HANDLE" --hmac-session \
			-S "/tmp/$ENC_SESSION_FILE"
		tpm2 startauthsession -c "$DEFAULT_HANDLE" --hmac-session \
			-S "/tmp/$DEC_SESSION_FILE"
		tpm2 sessionconfig --disable-encrypt "/tmp/$DEC_SESSION_FILE"
	fi
}

usage()
{
	echo "Usage: tpmx [COMMAND] [ARGS]                                                   "
	echo "Commands:                                                                      "
	echo "  extend [ARGUMENT] [PCR]    extends argument into pcr (default pcr is 4)      "
	echo "  reset                      clears all keys from tpm and take ownership       "
	echo "TPM2 only commands:                                                            "
	echo "  startsession               establish a secure channel with the tpm           "
}

cmd="$1"
shift 1
case "$cmd" in
	extend)
		extend "$@";;
	reset)
		reset "$@";;
	startsession)
		tpm2_startsession "@";;
	*)
		usage
		exit 1
esac
